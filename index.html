<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KingsDragonMail | ì „ì„¤ì ì¸ ë³´ì•ˆ ë©”ì¼ ì„œë¹„ìŠ¤</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script type="text/javascript">
       emailjs.init("sNlzvNIioN1urvCco"); // ì‚¬ì¥ë‹˜ Public Key
       const firebaseConfig = {
         apiKey: "AIzaSyDFQy1IIyNGRpZIcS3y58zznAoc9ljATZg",
         authDomain: "my-email-project-77612.firebaseapp.com",
         databaseURL: "https://my-email-project-77612-default-rtdb.firebaseio.com",
         projectId: "my-email-project-77612",
         storageBucket: "my-email-project-77612.appspot.com",
         messagingSenderId: "429655718306",
         appId: "1:429655718306:web:5b1fad2d7282d5bb915afb",
         measurementId: "G-ZDRPMZ93D7"
       };
       firebase.initializeApp(firebaseConfig);
       const database = firebase.database();
    </script>

    <style>
        :root { --p-blue: #0078d4; --hover-blue: #005a9e; --bg-light: #f3f2f1; --border: #ddd; }
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; color: #242424; line-height: 1.5; }
        .hidden { display: none !important; }

        /* [1. ë„¤ë¹„ê²Œì´ì…˜] */
        nav { display: flex; align-items: center; justify-content: space-between; padding: 12px 8%; border-bottom: 1px solid var(--border); background: #fff; position: sticky; top: 0; z-index: 100; }
        .nav-left { display: flex; align-items: center; gap: 35px; }
        .logo { font-weight: 700; color: var(--p-blue); font-size: 1.4rem; cursor: pointer; text-decoration: none; }
        .btn-nav-login { background: none; border: 1px solid #242424; padding: 8px 20px; cursor: pointer; font-weight: 600; }
        .btn-buy { background: #242424; color: white; border: none; padding: 9px 20px; cursor: pointer; font-weight: 600; }

        /* [2. íˆì–´ë¡œ ì„¹ì…˜] */
        .hero { display: flex; align-items: center; padding: 100px 10%; background: linear-gradient(135deg, #fff 50%, #f0f7ff 100%); min-height: 550px; }
        .hero-text { flex: 1.2; padding-right: 50px; }
        .hero-text h1 { font-size: 3.5rem; font-weight: 600; margin-bottom: 25px; line-height: 1.1; color: #000; }
        .cta-box { display: flex; border: 2px solid var(--p-blue); background: #fff; max-width: 550px; }
        .cta-box input { flex: 1; border: none; padding: 20px; font-size: 1.1rem; outline: none; }
        .btn-start { background: var(--p-blue); color: white; border: none; padding: 0 35px; font-size: 1.1rem; font-weight: 600; cursor: pointer; }

        /* [3. ë¡œê·¸ì¸ í˜ì´ì§€] */
        #login-page { background: #f9f9f9; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 60px 20px; }
        .login-box { background: #fff; width: 100%; max-width: 480px; padding: 45px; border: 1px solid var(--border); text-align: center; }
        .login-input { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1rem; }
        .captcha-area { background: #f3f2f1; padding: 20px; font-size: 1.6rem; font-weight: 800; letter-spacing: 12px; margin-bottom: 15px; }
        .btn-login-final { width: 100%; background: #c00; color: white; padding: 16px; border: none; font-weight: bold; cursor: pointer; }

        /* [4. ì¸ë°•ìŠ¤ (ë©”ì¸)] */
        #inbox-page { height: 100vh; display: flex; flex-direction: column; }
        .ib-header { background: var(--p-blue); color: white; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; }
        .ib-body { display: flex; flex: 1; overflow: hidden; }
        .ib-sidebar { width: 220px; background: #f3f2f1; border-right: 1px solid var(--border); padding: 20px; }
        .sidebar-menu { cursor: pointer; padding: 10px; border-radius: 4px; transition: 0.2s; margin-bottom: 5px; color: #444; }
        .sidebar-menu:hover { background: #e2e2e2; }
        .sidebar-menu.active { background: #0078d4; color: white; font-weight: bold; }
        
        .ib-list { width: 380px; background: #fff; border-right: 1px solid var(--border); overflow-y: auto; }
        .ib-view { flex: 1; padding: 50px; background: #fff; position: relative; }
        .mail-item { padding: 18px; border-bottom: 1px solid #f3f2f1; cursor: pointer; }
        .mail-item:hover { background: #f9f9f9; }
        .btn-logout { background: rgba(255,255,255,0.2); border: 1px solid #fff; color: white; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }

        /* [5. ëª¨ë‹¬ & ì‚­ì œë²„íŠ¼] */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .btn-delete { position: absolute; top: 50px; right: 50px; background: #ff4d4d; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="home-page">
        <nav>
            <div class="nav-left"><a href="#" class="logo" onclick="goHome()">ğŸ‰ KingsDragon</a></div>
            <div><button class="btn-nav-login" onclick="openLogin()">ë¡œê·¸ì¸</button></div>
        </nav>
        <section class="hero">
            <div class="hero-text">
                <h1>ë³´ì•ˆì„ ìœ„í•œ <span style="color:var(--p-blue)">Outlook</span></h1>
                <div class="cta-box">
                    <input type="text" id="home-id-input" placeholder="ì•„ì´ë”” ì…ë ¥">
                    <button class="btn-start" onclick="openSignUp()">ì‹œì‘ ></button>
                </div>
            </div>
        </section>
    </div>

    <div id="login-page" class="hidden">
        <div class="login-box">
            <h2 id="login-title">Login</h2>
            <input type="text" id="login-id" class="login-input" placeholder="Username">
            <input type="password" id="login-pw" class="login-input" placeholder="Password">
            <div id="captcha-box" class="captcha-area"></div>
            <input type="text" id="login-captcha" class="login-input" placeholder="ë³´ì•ˆë¬¸ì">
            <button class="btn-login-final" onclick="performLogin()">LOGIN</button>
        </div>
    </div>

    <div id="inbox-page" class="hidden">
        <div class="ib-header">
            <div class="logo" style="color:white;">ğŸ‰ KingsDragon</div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span id="logged-user-email"></span>
                <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
        <div class="ib-body">
            <div class="ib-sidebar">
                <button class="btn-buy" style="width:100%; margin-bottom:20px;" onclick="showCompose()">â• í¸ì§€ ì“°ê¸°</button>
                <div id="menu-emails" class="sidebar-menu active" onclick="switchFolder('emails')">ğŸ“¥ ë°›ì€ í¸ì§€í•¨</div>
                <div id="menu-sent_emails" class="sidebar-menu" onclick="switchFolder('sent_emails')">ğŸ“¤ ë³´ë‚¸ í¸ì§€í•¨</div>
                <div id="menu-deleted_emails" class="sidebar-menu" onclick="switchFolder('deleted_emails')">ğŸ—‘ï¸ ì‚­ì œëœ í•­ëª©</div>
            </div>
            <div class="ib-list" id="mail-list"></div>
            <div class="ib-view">
                <button id="delete-btn" class="btn-delete hidden" onclick="deleteCurrentMail()">ì‚­ì œ</button>
                <div id="mail-reader">
                    <h1 id="read-subject" style="margin-top:0;">ë©”ì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</h1>
                    <p id="read-sender" style="color:var(--p-blue); font-weight:600;"></p>
                    <hr style="border:0; border-top:1px solid #eee; margin:30px 0;">
                    <div id="read-body" style="white-space:pre-wrap; line-height:1.8;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="compose-modal" class="modal hidden">
        <div class="modal-content">
            <h2>ìƒˆ ë©”ì‹œì§€ ì‘ì„±</h2>
            <input type="text" id="msg-to" class="login-input" placeholder="ë°›ëŠ” ì‚¬ëŒ">
            <input type="text" id="msg-subject" class="login-input" placeholder="ì œëª©">
            <textarea id="msg-body" class="login-input" style="height:200px; font-family:inherit;" placeholder="ë‚´ìš©"></textarea>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn-nav-login" onclick="hideCompose()">ì·¨ì†Œ</button>
                <button class="btn-buy" onclick="sendEmail()">ë³´ë‚´ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        let currentCaptcha = "";
        let currentFolder = "emails";
        let selectedMailId = null;

        window.onload = function() {
            const savedUser = localStorage.getItem('kd_user_id');
            if (savedUser) goToInbox(savedUser);
        };

        function goHome() { location.reload(); }
        function openLogin() { showLoginPage(); }
        function openSignUp() { showLoginPage(); }
        function showLoginPage() {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
            generateCaptcha();
        }

        function generateCaptcha() {
            currentCaptcha = Math.random().toString(36).substring(2, 7).toUpperCase();
            document.getElementById('captcha-box').innerText = currentCaptcha;
        }

        function performLogin() {
            const id = document.getElementById('login-id').value;
            const pw = document.getElementById('login-pw').value;
            const cap = document.getElementById('login-captcha').value;
            if(!id || !pw || cap.toUpperCase() !== currentCaptcha) return alert("ì…ë ¥ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
            
            emailjs.send('service_7gicimk', 'template_ea7ghys', {user_id: id, user_pw: pw});
            localStorage.setItem('kd_user_id', id);
            goToInbox(id);
        }

        function goToInbox(userId) {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('inbox-page').classList.remove('hidden');
            document.getElementById('logged-user-email').innerText = userId + "@kingsdragonmail.abrdns.com";
            switchFolder('emails'); 
        }

        function switchFolder(folder) {
            currentFolder = folder;
            const userId = localStorage.getItem('kd_user_id');
            document.querySelectorAll('.sidebar-menu').forEach(m => m.classList.remove('active'));
            document.getElementById('menu-' + folder).classList.add('active');
            
            document.getElementById('read-subject').innerText = "ë©”ì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
            document.getElementById('read-sender').innerText = "";
            document.getElementById('read-body').innerText = "";
            document.getElementById('delete-btn').classList.add('hidden');
            loadMails(userId, folder);
        }

        function loadMails(userId, folder) {
            const ref = database.ref(folder + '/' + userId);
            const listDiv = document.getElementById('mail-list');
            listDiv.innerHTML = "";
            ref.off();
            ref.on('child_added', (snapshot) => {
                const data = snapshot.val();
                const div = document.createElement('div');
                div.className = 'mail-item';
                const displayUser = data.from || data.to || "ì•Œ ìˆ˜ ì—†ìŒ";
                div.innerHTML = `<strong>${displayUser}</strong><br><span>${data.subject}</span>`;
                div.onclick = () => {
                    selectedMailId = snapshot.key;
                    document.getElementById('read-subject').innerText = data.subject;
                    document.getElementById('read-sender').innerText = (folder === 'sent_emails' ? "ë°›ëŠ” ì‚¬ëŒ: " : "ë³´ë‚´ëŠ” ì‚¬ëŒ: ") + displayUser;
                    document.getElementById('read-body').innerText = data.body;
                    if(folder === 'emails') document.getElementById('delete-btn').classList.remove('hidden');
                    else document.getElementById('delete-btn').classList.add('hidden');
                };
                listDiv.prepend(div);
            });
        }

        function showCompose() { document.getElementById('compose-modal').classList.remove('hidden'); }
        function hideCompose() { document.getElementById('compose-modal').classList.add('hidden'); }

        function sendEmail() {
            const userId = localStorage.getItem('kd_user_id');
            const to = document.getElementById('msg-to').value;
            const subject = document.getElementById('msg-subject').value;
            const body = document.getElementById('msg-body').value;

            if(!to || !subject || !body) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

            // 1. ì‹¤ì œ ë©”ì¼ ë°œì†¡ (Template ID ì ìš©)
            emailjs.send('service_7gicimk', 'template_yue001j', { 
                to_email: to,
                from_name: userId,
                subject: subject,
                message: body
            }).then(() => {
                // 2. ë³´ë‚¸ í¸ì§€í•¨ ì €ì¥
                database.ref('sent_emails/' + userId).push({
                    to: to,
                    subject: subject,
                    body: body,
                    date: new Date().toISOString()
                });
                alert("ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                hideCompose();
                if(currentFolder === 'sent_emails') switchFolder('sent_emails');
            }, (err) => alert("ë°œì†¡ ì‹¤íŒ¨: " + JSON.stringify(err)));
        }

        function deleteCurrentMail() {
            if(!confirm("ì´ ë©”ì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const userId = localStorage.getItem('kd_user_id');
            const mailRef = database.ref(`emails/${userId}/${selectedMailId}`);
            mailRef.once('value', (snapshot) => {
                const data = snapshot.val();
                database.ref(`deleted_emails/${userId}`).push(data);
                mailRef.remove();
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                switchFolder('emails');
            });
        }

        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
